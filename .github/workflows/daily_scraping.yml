name: Daily Labangba Scraping

on:
  schedule:
    # 23:56 KST = 14:56 UTC
    - cron: '56 14 * * *'
    
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰'
        required: false
        default: 'false'

jobs:
  scrape-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
    
    - name: Install dependencies
      run: |
        pip install requests pandas streamlit plotly
        sudo apt-get update && sudo apt-get install -y zstd
    
    - name: Decompress database
      run: |
        if [ -f "schedule.db.zst" ]; then
          echo "ğŸ“¦ DB ì••ì¶• í•´ì œ..."
          zstd -d schedule.db.zst -o schedule.db --force
        fi
        ls -lh schedule.db
    
    - name: Create backup
      run: |
        mkdir -p backups
        cp schedule.db "backups/schedule_$(date +%Y%m%d_%H%M).db"
        echo "ğŸ’¾ ë°±ì—… ìƒì„± ì™„ë£Œ"
        
        # 7ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ
        find backups -name "*.db" -mtime +7 -delete || true
    
    - name: Update cookie from secrets
      env:
        LABANGBA_COOKIE: ${{ secrets.LABANGBA_COOKIE }}
      run: |
        if [ ! -z "$LABANGBA_COOKIE" ]; then
          python cookie_updater.py
        fi
    
    - name: Run scraping
      run: |
        echo "ğŸš€ í¬ë¡¤ë§ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S')"
        python scrape_schedule.py
    
    - name: Check data quality
      id: data_check
      run: |
        python check_data.py
    
    - name: Update aggregate tables
      if: success()
      run: |
        if [ -f "update_aggregate_tables.py" ]; then
          python update_aggregate_tables.py || true
        fi
    
    - name: Compress database
      run: |
        echo "ğŸ“¦ DB ì••ì¶•..."
        zstd -19 schedule.db -o schedule.db.zst --force
        rm schedule.db
        ls -lh schedule.db.zst
    
    - name: Generate status report
      if: always()
      run: |
        python3 - <<EOF
        import json
        import sqlite3
        from datetime import datetime
        import os
        
        # ì²´í¬ ê²°ê³¼ ë¡œë“œ
        status = {}
        if os.path.exists('data_check.json'):
            with open('data_check.json', 'r') as f:
                status = json.load(f)
        
        # README ìƒì„±
        badge_color = 'success' if status.get('status') == 'OK' else 'critical'
        badge_text = status.get('message', 'Unknown')
        
        readme = f'''# ë¼ë°©ë°” ë°ì´í„° ìˆ˜ì§‘ ì‹œìŠ¤í…œ

![ìƒíƒœ](https://img.shields.io/badge/Status-{badge_text.replace(' ', '%20')}-{badge_color})
![ì—…ë°ì´íŠ¸](https://img.shields.io/badge/Updated-{datetime.now().strftime('%Y---%m---%d %H:%M').replace(' ', '%20')}-blue)

## ğŸ“Š ìµœê·¼ ìˆ˜ì§‘ ê²°ê³¼

- **ë‚ ì§œ**: {status.get('date', 'N/A')}
- **ì´ ë ˆì½”ë“œ**: {status.get('total', 0):,}ê°œ
- **0ì› ë§¤ì¶œ**: {status.get('zero_count', 0)}ê°œ ({status.get('zero_ratio', 0):.1f}%)
- **í‰ê·  ë§¤ì¶œ**: {status.get('avg_revenue', 0):,.0f}ì›

---
*ìë™ ì—…ë°ì´íŠ¸: ë§¤ì¼ 23:56*
'''
        
        with open('README.md', 'w') as f:
            f.write(readme)
        EOF
    
    - name: Commit and push
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add schedule.db.zst README.md data_check.json backups/
        
        if [ -f "data_check.json" ]; then
          STATUS=$(python3 -c "import json; print(json.load(open('data_check.json'))['status'])")
          TOTAL=$(python3 -c "import json; print(json.load(open('data_check.json'))['total'])")
          MESSAGE="ğŸ“Š Update: $(date +%Y-%m-%d) - $TOTAL records [$STATUS]"
        else
          MESSAGE="ğŸ“Š Update: $(date +%Y-%m-%d)"
        fi
        
        git diff --quiet && git diff --staged --quiet || {
          git commit -m "$MESSAGE"
          git push
        }
    
    - name: Send Discord notification
      if: always()
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        if [ ! -z "$DISCORD_WEBHOOK" ] && [ -f "data_check.json" ]; then
          python3 - <<EOF
          import json
          import requests
          import os
          
          with open('data_check.json', 'r') as f:
              data = json.load(f)
          
          # ìƒ‰ìƒ ê²°ì •
          if data['status'] == 'OK':
              color = 0x00FF00
          elif data['status'] == 'WARNING' or data['status'] == 'CAUTION':
              color = 0xFFA500
          else:
              color = 0xFF0000
          
          webhook_url = os.environ['DISCORD_WEBHOOK']
          
          embed = {
              "title": f"ë¼ë°©ë°” í¬ë¡¤ë§ - {data['status']}",
              "color": color,
              "fields": [
                  {"name": "ë‚ ì§œ", "value": data['date'], "inline": True},
                  {"name": "ë ˆì½”ë“œ", "value": f"{data['total']}ê°œ", "inline": True},
                  {"name": "0ì› ë¹„ìœ¨", "value": f"{data['zero_ratio']:.1f}%", "inline": True},
                  {"name": "ë©”ì‹œì§€", "value": data['message'], "inline": False}
              ]
          }
          
          requests.post(webhook_url, json={"embeds": [embed]})
          EOF
        fi
