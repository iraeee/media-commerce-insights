name: Daily Labangba Scraping

on:
  schedule:
    # KST ê¸°ì¤€ ì‹¤í–‰ ì‹œê°„ (UTC = KST - 9ì‹œê°„)
    - cron: '0 22 * * *'   # 07:00 KST (22:00 UTC ì „ë‚ )
    - cron: '0 3 * * *'    # 12:00 KST (03:00 UTC)
    - cron: '0 8 * * *'    # 17:00 KST (08:00 UTC)
    - cron: '0 12 * * *'   # 21:00 KST (12:00 UTC)
    - cron: '30 14 * * *'  # 23:30 KST (14:30 UTC)
    - cron: '45 14 * * *'  # 23:45 KST (14:45 UTC)
    - cron: '56 14 * * *'  # 23:56 KST (14:56 UTC)
    
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ê°•ì œ ì‹¤í–‰'
        required: false
        default: 'false'

permissions:
  contents: write
  actions: read

jobs:
  scrape-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
    
    - name: Install dependencies
      run: |
        pip install requests pandas streamlit plotly
        sudo apt-get update && sudo apt-get install -y zstd
    
    - name: Decompress database
      run: |
        if [ -f "schedule.db.zst" ]; then
          echo "ðŸ“¦ DB ì••ì¶• í•´ì œ..."
          zstd -d schedule.db.zst -o schedule.db --force
        else
          echo "DB íŒŒì¼ ì—†ìŒ - ìƒˆë¡œ ìƒì„±"
          touch schedule.db
        fi
        ls -lh schedule.db || true
    
    - name: Create backup
      run: |
        mkdir -p backups
        if [ -f "schedule.db" ]; then
          cp schedule.db "backups/schedule_$(date +%Y%m%d_%H%M).db"
          echo "ðŸ’¾ ë°±ì—… ìƒì„± ì™„ë£Œ"
        fi
        # 7ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ
        find backups -name "*.db" -mtime +7 -delete 2>/dev/null || true
    
    - name: Update cookie from secrets
      env:
        LABANGBA_COOKIE: ${{ secrets.LABANGBA_COOKIE }}
      run: |
        if [ ! -z "$LABANGBA_COOKIE" ] && [ -f "cookie_updater.py" ]; then
          python cookie_updater.py || echo "ì¿ í‚¤ ì—…ë°ì´íŠ¸ ìŠ¤í‚µ"
        fi
    
    - name: Run scraping
      run: |
        echo "ðŸš€ í¬ë¡¤ë§ ì‹œìž‘: $(date '+%Y-%m-%d %H:%M:%S') KST"
        if [ -f "scrape_schedule.py" ]; then
          python scrape_schedule.py || echo "í¬ë¡¤ë§ ì‹¤íŒ¨ - ë¡œê·¸ í™•ì¸"
        else
          echo âš ï¸ scrape_schedule.py íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
        fi
    
    - name: Check data quality
      id: data_check
      run: |
        if [ -f "check_data.py" ]; then
          python check_data.py || echo "ë°ì´í„° ì²´í¬ ì‹¤íŒ¨"
        else
          echo "check_data.py íŒŒì¼ ì—†ìŒ"
        fi
    
    - name: Update aggregate tables
      if: success()
      run: |
        if [ -f "update_aggregate_tables.py" ]; then
          python update_aggregate_tables.py || true
        fi
    
    - name: Compress database
      run: |
        if [ -f "schedule.db" ]; then
          echo "ðŸ“¦ DB ì••ì¶•..."
          zstd -19 schedule.db -o schedule.db.zst --force
          rm schedule.db
          ls -lh schedule.db.zst
        fi
    
    - name: Generate README
      if: always()
      run: |
        if [ -f "generate_readme.py" ]; then
          python generate_readme.py
        else
          echo "generate_readme.py ì—†ìŒ - README ì—…ë°ì´íŠ¸ ìŠ¤í‚µ"
        fi
    
    - name: Commit and push
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add -A
        
        # ì‹œê°„ í¬í•¨ëœ ì»¤ë°‹ ë©”ì‹œì§€
        MESSAGE="ðŸ“Š Update: $(date +%Y-%m-%d' '%H:%M) KST"
        if [ -f "data_check.json" ]; then
          STATUS=$(python3 -c "import json; print(json.load(open('data_check.json')).get('status', 'UNKNOWN'))" 2>/dev/null || echo "UNKNOWN")
          TOTAL=$(python3 -c "import json; print(json.load(open('data_check.json')).get('total', 0))" 2>/dev/null || echo "0")
          MESSAGE="ðŸ“Š Update: $(date +%Y-%m-%d' '%H:%M) KST - $TOTAL records [$STATUS]"
        fi
        
        git diff --quiet && git diff --staged --quiet || {
          git commit -m "$MESSAGE"
          git push origin main
        }
    
    - name: Send Slack notification
      if: always()
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      run: |
        if [ ! -z "$SLACK_WEBHOOK" ] && [ -f "send_slack.py" ]; then
          python send_slack.py || echo "Slack ì•Œë¦¼ ì‹¤íŒ¨"
        fi
